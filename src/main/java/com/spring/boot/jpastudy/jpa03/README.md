# 03 엔티티 CRUD 처리

- 생성
  - 엔티티 매니저는 트랜잭션을 커밋하기 전에 DB에 엔티티를 저장하지 않고, 내부 저장소에 insert sql을 모아둔다.
  - 트랜잭션을 커밋할 때 모아둔 SQL을 DB에 보낸다. 이것을 "쓰기 지연"이라고 한다.
  - 트랜잭션을 커밋하면 영속성 컨텍스트는 flush를 하는데 flush는 영속성 컨텍스트의 변경 내용을 DB에 동기화하는 작업을 말한다.
- 조회
  - 영속성 컨텍스트는 내부에 캐시를 가지고 있는데, 이것을 1차 캐시라 부른다.
  - 영속상태의 엔티티는 이곳에 모두 저장된다.
- 수정
  - 엔티티를 수정할 떄는 엔티티는 조회 후 데이터만 변경해주면 된다.
  - 이렇게 엔티티의 변경사항을 DB에 자동으로 반영하는 것을 더티 체킹 (Dirty Checking) 이라고 한다.
- 삭제 
  - 엔티티를 삭제하려면 삭제 대상 엔티티를 조회하고 엔티티 매니저에 삭제 대상 엔티티를 넘겨주면 해당 엔티티를 삭제한다.
  - 엔티티 등록과 동일하게 삭제 쿼리를 쓰기 지연 SQL 저장소에 등록한 뒤 트랜잭션을 커밋해서 플러시를 호출하면 DB에 삭제쿼리를 전달한다.


### Flush란?

---

**플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스 반영한다.**
플러시를 실행하면 아래와 같은 일이 일어난다.
1. 변경 감지가 동작해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티를 찾는다.
2. 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 SQL 저장소에 등록한다.
3. 쓰기 지연 SQL 저장소의 쿼리를 데이터 베이스에 전송한다.

DB에 변경 내용을 SQL로 전달하지 않고 트랜잭션만 커밋하면 어떤 데이터도 DB 반영되지 않는다. 그래서 트랜잭션을
커밋하기 전에 플러시를 호출해서 영속성 컨텍스트의 변경 내용을 DB에 반영해야 한다. JPA는 이러한 문제를 예방하기
위해 트랜잭션을 커밋할 때 플러시를 자동 호출한다.






---
[공식 문서](https://www.baeldung.com/hibernate-save-persist-update-merge-saveorupdate)
